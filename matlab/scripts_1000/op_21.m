function [Y,Xf,Af] = op_21(X,~,~)
%OP_21 neural network simulation function.
%
% Generated by Neural Network Toolbox function genFunction, 17-Apr-2019 12:10:02.
% 
% [Y] = op_21(X,~,~) takes these arguments:
% 
%   X = 1xTS cell, 1 inputs over TS timesteps
%   Each X{1,ts} = 3xQ matrix, input #1 at timestep ts.
% 
% and returns:
%   Y = 1xTS cell of 1 outputs over TS timesteps.
%   Each Y{1,ts} = 2xQ matrix, output #1 at timestep ts.
% 
% where Q is number of samples (or series) and TS is the number of timesteps.

%#ok<*RPMT0>

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [3.2387e-13;-0.0017771;-0.0038859];
x1_step1.gain = [2.18660485863677;8.21601210382903;14.9503759645796];
x1_step1.ymin = -1;

% Layer 1
b1 = [-2.5007111557223513643;-1.8672656763146497916;0.032060668029510373811;4.3583249107987498405;-2.583338386566213174;-1.3266613718614950201;1.5191951704109223353;5.3072459730865517713];
IW1_1 = [1.8868724162002301625 1.7155507462819556963 -0.7568971534339367091;1.4703649947300028167 0.64466705374489807756 -0.43104881811103251676;0.98215462245853679679 0.0299651828097134941 -0.23663216671600276197;-0.12478474836533964831 3.9462663637726826948 0.54452779608513446341;-2.7429570593608545437 0.7011688288062314367 -0.37678282505643873046;-0.17683982265069997375 -0.65388463461930834697 -0.49036542347621525639;1.8431208259331619548 -0.96460327094804787507 0.046969436081281894235;4.7199592770343947734 3.067463198708089589 -2.6586218601507649595];

% Layer 2
b2 = [0.93339329647826485559;-1.1446477663629126553;-0.071062809145424024604;0.4975205051162719383;-0.071381411414524059689;0.018922076831937518354;-0.99479100673415454814;2.1518158332856360815];
LW2_1 = [-0.18040910076690880315 1.6870043047219982491 0.76055497454407172686 0.21504476410094658378 -0.61024969261952455302 -0.13142568415940625304 -0.5353646860349864367 0.51460282967597703596;0.92445332898089416229 -0.65026540365289164924 -0.48993214336177381973 -0.82055056676875592903 -0.052260337563904281366 0.16056563308172108751 -0.2579134610060502264 -0.92519372655577536424;0.196578614721547279 -0.077497516699243595983 0.013088570909837220213 -6.1235264011842360787 -2.0192274593006427352 2.560450091886295354 1.1390512853358092382 -5.295566301965512146;-0.65859922261873693472 -0.48191828318501511719 -0.46348227861854873755 0.82753739398541370509 0.34679058441612092833 0.1547967943860044937 1.2713802708951535969 0.48739774000810387466;-0.090682957011413864445 0.0058689677674932990564 0.66421258215135037251 -0.9107175737089929779 0.13994954668770212547 1.1034770333406935805 1.431297178049007357 -0.32892235731601232596;0.69147996212306728214 -0.29580645778472713925 0.56431268439501314216 -2.2911724701561952955 -2.3118218318558318991 1.2533439527200949115 0.71666233060627482221 3.3034644265616956993;-0.32229214129180761006 0.74870239517963965703 -0.83088828126425773313 -0.92934204515369189803 1.5865727920523540195 -0.19065823677485263521 -0.1518413018303581552 -1.2306455996527134733;-0.10059400836903480136 -1.0170049229780486755 0.14077074658154020703 -0.83529272461737469335 0.20947047070195895513 -0.54210336331817965405 1.2532472013155735446 0.15667442220913099793];

% Layer 3
b3 = [1.1757040024487392937;-1.1324291149348688634;-0.34443420944336655687;-0.010846818069583548383;0.16104012373493792332;0.60635675229410734843;-0.90339408436749557563;1.7014495525471555748];
LW3_2 = [0.6908305067174577152 -0.40084276399667795321 -7.0081738987827169041 -1.2728756461936521216 -2.7790754914657438412 -1.9934628817129524947 -0.67098470359004358521 -1.2843396634460473305;0.82320618196739780981 0.73246208054975259216 0.17939866182038427533 -0.48785986164976780088 -0.30386475914573446433 -0.042789855994154121777 0.82830057779964627596 -0.036536002963951555444;1.0926995327114061851 0.3648120713532766457 -1.9330355631734510435 0.23941276969081029535 0.84961652512467678022 0.23882558899206252079 0.26430435755679787535 1.000732048610616598;1.1046295435324013923 0.37555798038425192154 2.7969691951139226127 -0.43438832787302650296 0.65174856180064144606 3.3159264665375594028 -1.4570127066869833499 0.67803676746824381727;-0.01273769458631752137 -0.63839072031802546192 -0.20335856154094192338 0.041545485930367678784 -0.33411215932340210255 0.52771743860664466208 1.0718923383649012759 1.4729933950008287091;0.48300611019807115909 -0.41053587619595360847 1.0754651457108843626 -0.31334130790493291974 -0.80399482005856603983 2.3845405090503599688 0.54656300007432245813 0.30226889279813823341;0.85854959779198136705 0.10739515645873000393 -0.094412497838780626291 -0.81678221335195233532 -1.3758006631487822435 -1.0745368078648473986 0.082554600192410024229 -0.19453622438796064342;1.3849584713780418443 0.32700696830492242961 -1.1533537971136875733 0.27328225515957871306 1.4462199347276345485 -1.078290137562373463 -0.45886876520359148879 0.81043145786265380348];

% Layer 4
b4 = [1.4682463562806618018;0.84476624476626194227;1.5020217342068917787;-0.45791103468322547076;0.33688848394603043701;0.61894624449831936452;1.3185535529795224807;-1.4261509900756288438];
LW4_3 = [-1.5265084006979123821 0.83163942957094449948 1.1631234182282170764 0.76035057342225909061 -0.23149367726453515259 -0.15723055486923165347 -0.34144730639969217423 -0.87477482278254037329;-4.0631835335954393784 0.026341147587832489801 -3.8148319967009625131 -1.9683898107511239584 -0.82587643958336431904 -3.1097318534024078751 -0.107014646052033785 -0.87424721264422733391;0.5344209650500169051 -0.038039129370278583486 -1.3948669951548278156 -0.8333301448489864871 0.10239555520810508793 -1.2600805201223965746 -1.3123476932217161828 -0.31880623583539646759;1.2433413680163807324 0.29303681557123850698 0.44679998354967187524 -0.82368765341308847194 0.57149151502587658413 1.3623801519644405111 1.3468542499328890472 -0.73316553791904448545;-0.17483253659311417949 -0.37375629503966711908 -1.4992320751733052564 -1.0910328970544869165 -0.74375559564475746122 -0.43344101462762857357 0.44685017340644639372 -0.012126997622903356103;6.9047067856664332552 -0.24688886693799885763 1.0244963329705558674 -4.5908693409363579008 -1.1935756834648565405 -1.6506248353627601677 0.53005875216859521526 -0.10569814948666278465;0.96516582449342136485 0.15278083830588262693 -0.22072823187446041771 -0.70097067237039301091 -0.29597238598582559232 0.49843233773877615445 0.53659010218758662614 1.3543346380403433749;-0.33307892280502154891 -0.27879970563872874534 0.70334602551326130815 -0.46897993653985275975 -0.94318669706585089862 -0.12848033982663903396 0.22537512899284412038 -0.83534372306362314475];

% Layer 5
b5 = [-2.0060097147994420119;1.1368249409524484594;0.27889265603542312544;0.33412420805820308711;0.24978386526224646835;-0.69870864597270732066;1.1691719353965486228;1.2181574776334451737];
LW5_4 = [0.81280615369084696642 -2.0688308849627534691 0.44661076153900619579 -1.5690866698242036392 0.78509220177898952908 2.2399653002996986473 0.50370891777328141714 0.48085517396503357768;0.61453190723389128358 0.25045295837011538609 -1.1164148823801067767 0.39940394487883124075 -0.41877650376981317981 -2.0617342191700038789 0.2552462437172339782 -0.89779018352373207712;-1.3669903599892456736 1.7588786014742359143 -1.4419951393815240159 0.64575922336240376698 1.4624588877816140364 2.7529229748219905538 1.0833485671802611794 0.64571970974096071227;-0.27604927699549486331 -0.26423378485166698626 1.2707044655403862965 -0.67245736186036841886 -0.16234643854791880324 0.5312233779721831084 0.66991540090509982264 -0.77769637792075896332;1.2168521977305468695 -4.3733983408966494721 0.50234457753171923855 -0.58360142083716670669 -1.5023686432049692119 -4.7821181220795008215 0.41359825234427921581 -0.76090079163787871508;-0.97791441913691434795 -2.0928315467205509393 0.9344787273984105358 -0.60307706676075112373 0.018619050517627334929 -0.97172879658421351667 -0.30878599371149345609 0.40681783945543548153;-0.75274280663073844799 -0.51786979220316886607 0.91131220027850212695 -0.51018114924618529482 0.22951464562448981033 -1.0968958243421720322 0.51078451122919699134 -0.4807818922576165277;0.53085729356569588688 0.1980005585957823333 -1.3841424203017296257 1.2491283433305409023 -0.92241357109936050751 -0.59883243806137620435 -0.61947221043991762546 1.2059460562896204827];

% Layer 6
b6 = [-1.2896652571561482148;-0.1885036401120248617;-0.50108353742627409488;-0.27694517717450373162;0.48883170346658533223;0.14480159659692315444;0.84447558747314055427;1.84452614096322276];
LW6_5 = [0.28875001409183687073 -0.45827208278127817831 0.46727810643748779462 0.29560753939161349413 -0.28757899866340080886 -0.93871331343679487169 0.42985398010276132386 1.1977462421664866188;-0.17293928748613793256 0.61944140071656839108 -0.87464946012364930272 -0.62419655812996110988 1.9625989956167051442 -0.79654725313703711453 1.1136884422215507229 -0.24978958241284951458;1.1281160750171599361 -0.38724731552312868788 0.14774666854780463265 0.36651461333063428683 -0.5278576869429779661 -0.49624737272523017362 -0.69920023296234379284 0.14190948558378035926;1.2489740024006292796 -1.3409445960494721373 -1.0271276656610059952 0.19617224874006292112 0.37702701828504059378 -1.2238331921549585601 -0.32991403143168324119 0.76048653309840952286;0.35621832224077376594 1.0597537141288944085 -0.92198405381917780677 0.49421879814840113943 -0.67493425080742408539 0.20782991017712795778 -0.14770536516481738709 -1.6896023245897013876;1.0416628920845514283 0.013301958401741149907 -0.089534306399906254947 0.35868140033160467173 -0.52209335181036720108 -0.15296680835665457665 0.51383687430058933021 -1.4571676431068294466;-1.1888377759665103017 0.29760776756920787056 -2.073562571775245722 -0.88983062129080303659 1.4519374597306964336 0.45955219473040820333 0.57012205466546139743 1.623003336999998325;3.0825737385628224629 -0.26287737091361823571 2.7751956746961745637 0.89872515380326178924 -4.8025997629742942507 0.94879770437615651435 -1.0482229085819911862 -0.33685832970492463057];

% Layer 7
b7 = [0.72023793526547297272;1.0601438204626694173];
LW7_6 = [0.19679848897148005671 -0.84757661524390925933 -0.72820309880920275347 -2.8222585394435917294 0.49624074143520663371 0.82490996723971854454 2.8584461725055674286 3.5953762337789916259;0.6844937935756482128 0.88918363824115487226 -0.64945632466283176321 0.12173240008411276292 -2.1472301533255979678 -0.52046190977742645689 -0.010254640318823953979 0.12528358030285180469];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [8.03212851405623;6.68896321070234];
y1_step1.xoffset = [0.001;0.001];

% ===== SIMULATION ========

% Format Input Arguments
isCellX = iscell(X);
if ~isCellX, X = {X}; end;

% Dimensions
TS = size(X,2); % timesteps
if ~isempty(X)
  Q = size(X{1},2); % samples/series
else
  Q = 0;
end

% Allocate Outputs
Y = cell(1,TS);

% Time loop
for ts=1:TS

    % Input 1
    Xp1 = mapminmax_apply(X{1,ts},x1_step1);
    
    % Layer 1
    a1 = tansig_apply(repmat(b1,1,Q) + IW1_1*Xp1);
    
    % Layer 2
    a2 = tansig_apply(repmat(b2,1,Q) + LW2_1*a1);
    
    % Layer 3
    a3 = tansig_apply(repmat(b3,1,Q) + LW3_2*a2);
    
    % Layer 4
    a4 = tansig_apply(repmat(b4,1,Q) + LW4_3*a3);
    
    % Layer 5
    a5 = tansig_apply(repmat(b5,1,Q) + LW5_4*a4);
    
    % Layer 6
    a6 = tansig_apply(repmat(b6,1,Q) + LW6_5*a5);
    
    % Layer 7
    a7 = repmat(b7,1,Q) + LW7_6*a6;
    
    % Output 1
    Y{1,ts} = mapminmax_reverse(a7,y1_step1);
end

% Final Delay States
Xf = cell(1,0);
Af = cell(7,0);

% Format Output Arguments
if ~isCellX, Y = cell2mat(Y); end
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
  y = bsxfun(@minus,x,settings.xoffset);
  y = bsxfun(@times,y,settings.gain);
  y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
  x = bsxfun(@minus,y,settings.ymin);
  x = bsxfun(@rdivide,x,settings.gain);
  x = bsxfun(@plus,x,settings.xoffset);
end
