function [Y,Xf,Af] = op_4(X,~,~)
%OP_4 neural network simulation function.
%
% Generated by Neural Network Toolbox function genFunction, 17-Apr-2019 10:01:37.
% 
% [Y] = op_4(X,~,~) takes these arguments:
% 
%   X = 1xTS cell, 1 inputs over TS timesteps
%   Each X{1,ts} = 3xQ matrix, input #1 at timestep ts.
% 
% and returns:
%   Y = 1xTS cell of 1 outputs over TS timesteps.
%   Each Y{1,ts} = 2xQ matrix, output #1 at timestep ts.
% 
% where Q is number of samples (or series) and TS is the number of timesteps.

%#ok<*RPMT0>

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [3.2387e-13;2.3531e-14;-0.00087186];
x1_step1.gain = [2.18660485863677;2.375917698211;5.574728595732];
x1_step1.ymin = -1;

% Layer 1
b1 = [0.23803343203153812246;1.7432022520734864468;-1.7405978952754965761;2.1763389667326737964;3.7868733381235069047;-0.32894336329510348582;0.33653106118203018893;-5.2043620606275107221];
IW1_1 = [0.040324616848869010433 -0.36494197371968356558 -0.045535899501065631167;2.398002290740597342 0.1019826579221422419 -0.76014799792744880413;-1.6301724698599693308 0.49222994500749195357 -0.88800394333287613335;4.9377455627238520108 -1.2590435910733888125 -1.5696894778450902752;-0.24726160716118666949 1.9406288443285029111 2.1573366724058180566;-3.3819110287655513858 2.6044639969817855452 0.44268570968516274267;0.20542091821091953974 0.81003226094844049676 -0.81149512142598534403;-1.1181520507747886306 -4.6885468543283348453 0.6064871689240112218];

% Layer 2
b2 = [0.80341450009208947858;-0.24963912886643338518;-0.22556677489990517582;-0.61325231340878672004;-0.56587351310913891478;0.78162708860772500685;-0.058539735288035806005;0.21660299546556474604];
LW2_1 = [0.92258723044985502248 -0.89317736444810802432 0.50100774683408177967 0.41112838118306604951 -0.21680615242531686704 0.058142282893196409188 0.39875446344281273436 -1.0643835210583529882;0.090255138485481348209 -0.84026928083060914432 1.2502700760614451347 -1.8675400774156309947 -1.6098854251248908565 0.21375256752946286687 -0.70521921487149274999 3.0240693452766667093;-0.067386267491048534861 -2.8001629199964703787 2.0932059178888162698 -5.1457074730912335525 0.35172069031898556268 4.4692039708777828722 0.20010053172472683225 -0.94307350670671941106;-0.40113723787882860083 0.69706899468623828575 -0.53940300405901331349 -0.07852294396220142747 0.37362786964951349988 -0.35644457881960245338 -0.52239203714452886462 0.009752536829180763131;1.2685856211382176006 0.27629206659600730189 0.31272619328791279036 0.77877199804291408203 -0.48793480135960659583 -0.48490203483934635198 0.5931221653226111945 1.3996212114764903234;-0.45744541302434560404 2.2699075125171290779 -0.81675652389077812998 -0.11130772077660854025 5.5503802130806523252 1.897220059829298977 0.60446523917127059633 -4.8838382200390926258;0.11923056561395074804 -1.1853514522572083933 0.31562319066538035983 -0.99870536018480293716 0.0066160094848170475715 0.58824729822823385028 0.050436230281727389979 -0.0053864070060196077294;0.019817162851572117654 -0.50760266871373138642 0.11862381061581661612 -0.40589013756928571386 0.35459609691528676256 -0.14890627427029931584 -0.1831696525259032815 -1.8318224029091727534];

% Layer 3
b3 = [0.14711105361533513558;-0.024094956392246708043;0.086333714481113585371;0.42399058690279989303;0.37551365616023313354;-0.045217447253115231054;-0.28502025090647903349;0.14971353750713370379];
LW3_2 = [-0.33140023713348909506 -0.68726712768820719113 1.6398535760183212684 -0.056793183009405376338 -0.47263033751444305519 1.9408943310131478999 0.91182410970094462943 0.69394118256501258202;0.1451031703066050782 0.383795947019174577 0.33036638276781588042 -0.29223080187471889291 -0.76451745170740470492 -0.44772926008027463807 0.3933210444566747066 -0.062946229476020243432;-0.88253731433540194562 -0.44021694170323860673 -0.71813931806724007334 0.076379072535559852652 -0.27158346432240954016 0.20264848411726354982 0.010424326054450100063 0.064909880320864379866;-0.36126300831894275767 4.0422550251976510083 5.2160899809832335094 0.064593713540245872862 -0.14371625699279313992 -4.0263557136054766161 2.4262720843580303232 -0.34750564042534792808;-0.038795366027232179584 0.024084623061827674373 -1.0075326280689980152 -0.3079915099751652785 -0.21662562400288282172 -0.37055427717298478063 -0.59783567772957535436 -0.24703682993947551072;-0.15085069766083913922 1.908367327562182858 -0.05926830337181371311 -0.35444598162025181542 1.5029480871387823626 -5.4310914528969975734 0.0054863178191233430425 -0.99266161541006003866;-0.081041738317827960447 -0.87653334463673038268 -1.2086741421775972771 0.41533075798155466574 0.062266915310419487795 -0.19580220395666009248 -0.24845917587320207054 -0.035604143877466520873;-0.63997697919295537528 -0.53801391487904626221 5.9579585486304464936 0.38544367529502704395 -0.53995249257530497644 2.5404907615693446132 0.90363629053261929069 1.4498084876074268657];

% Layer 4
b4 = [-0.48163994032064139095;-0.49549194151998682267;-0.5325258123747853567;-0.096937577981041481157;0.5736135442348752056;1.7070095758924532792;0.64670540429539147276;0.77564034668329473465];
LW4_3 = [1.5787666630334526996 -0.59215803058134730552 -0.3547271112217873501 -1.2633440480907138781 -0.90619081341259954954 -2.7222676740106881432 -0.31949239090959163923 3.748153936709312628;-1.8216788243491115473 -0.35146992027907192346 -0.50649284193386945319 -3.3897890690511922607 0.58001985522427534914 -0.17904457853810623602 0.083528420611437531607 -3.8044129806009014949;0.61419049225307842388 0.011158199607103588477 -0.2814074039715295239 -1.6156842936482218587 -0.38747928744526405342 -3.8806458986728662452 -0.061975183157163819814 1.143728178604786816;-0.35954640832164835862 -0.2314725692938668089 -0.55447822017927284044 -0.44635634041475025224 -0.0086326316078653986263 0.52741237641222715737 -0.10602540629015728968 -0.38686106300280725945;-1.2198197533586365715 0.27292217935756918346 0.80380770497623332815 -0.56834021741630991187 0.31190753526041176125 0.89792286195186288289 0.31187681164047681426 -3.393868058745873828;0.86201309868878961407 -0.9209230998276791702 1.2299156634382584219 4.4062457816703224367 1.1224302670314094676 1.8113364637018167791 1.4933211515408559844 -0.28969742493304673214;0.57123376593465269302 -0.36208110198279841452 0.4744863128668970198 2.1221378587539567739 0.37040020573334692111 0.19629947870027947276 0.55828097174195356889 0.78461878428405462671;-1.7372717297043966944 -0.059282756813419670849 0.05610276771627900616 3.3811696346858863826 0.87360702043433424713 3.3474814522016198559 0.73756379569977115196 -2.0431429138154615366];

% Layer 5
b5 = [0.71000507321269379357;0.24570652158180447677;-0.44745339166011621757;-0.76152324758767298007;0.28561380799100316574;0.51756594633339214617;-0.3995642424159820405;1.7757814484688978496];
LW5_4 = [-0.54298824358100150622 0.13961679936969143001 -1.460441504610834107 -0.40469480419984765751 2.2188150273485924835 0.5013332069493340315 -0.24604783323788673166 1.8537847950338184333;-0.16296299678666950617 1.0659572398816645755 -0.24757874844746816101 -0.52432380232305786372 1.0464791406414175601 0.38928478894728080206 0.083322228734653655535 0.16614797143545292912;2.0862491036476065176 -1.870018361290063158 2.470976016407347764 -1.3430176420586121822 -1.7061230917614651492 1.8100309503154436985 1.307335934716165049 -2.2500735633188932994;4.687918284043478323 0.0080108788284597703261 1.8732633485679057728 -0.86696880527421371632 -2.4777839581181058115 -3.5227029912860086114 -0.46151069904276958988 -3.2726755039151109727;-0.75559214234628035989 2.2941854698870458584 -0.5887123120925635833 0.69035007238022016995 1.0221530493168957676 -0.017833483165106859408 -0.63686182979260053116 1.12675748031237144;-0.067181862855725360539 -0.28639804936697521587 0.18220286951824690713 -0.87040628620899407331 0.39813497762249222545 1.9568068091538879383 0.88099833997460719193 0.80285401243440013275;1.3377780369445497755 -4.6062430111865380056 -0.74463416951434024948 0.48746205337910625266 -2.7994508214575208882 2.7634984701108709082 2.0281310653373925135 0.18712217631622740655;-1.6630881497005765013 0.89724261392622328692 -0.62577020392522697545 1.517125014807879646 0.4128842727078935182 -1.2807985100492900177 -1.1558493603815211959 1.1021615223077445567];

% Layer 6
b6 = [0.12567169023401414396;-0.20746100655147087233;0.58866630088080840189;-0.25587404904974320186;-0.93898097902451127528;-0.50494703175388155891;0.33959547357013625257;-0.035541307186527322515];
LW6_5 = [0.90090909735369650857 0.87864965941594264098 -0.29890676239712304918 -1.5467004679904841069 1.1624922392244474434 0.35927433306972805793 -0.58739538473836727661 -0.15319116745779698396;0.99364876725263051593 0.17095948529989560272 -0.63444438177454942629 -1.8516683434637761785 0.17706042662863977211 2.1605185476444184189 0.56868422504464744005 -0.18136873793738672589;1.7638130633450861406 0.7543728607767674621 -1.3943685189749395192 -1.4437759601648465502 0.86910824069402670133 -0.79663439698094062891 -1.729165903670975446 0.013955228123378222646;-1.0370836945997679024 -0.54951396650875850014 0.15799285367385054735 0.32946795042259691133 0.54874820586598671568 -1.0320038685911883114 -0.76604197198156320781 1.0134472111682077955;-1.8552654784695259416 -1.4100676043633704193 3.9497323727086213196 3.9167287796663226018 -2.0598562494842420634 0.63512156733406521791 4.7261804522510821869 0.69447221980540008168;0.011074095462102090046 -0.066874505566306849391 0.0057504616280625829583 -0.0082082315244099424145 0.36680708647132892475 -0.018951877546195618901 -0.30970747634941109272 0.51240569369451993698;0.33830179651633618398 0.86603796246029240979 -0.31781446882050656821 -0.20182303981403043602 0.51816564401452591682 -0.61556407649436439833 -0.5071755247136233713 -0.61726190560539928587;1.2548758822090346765 -0.098229111260665136207 -1.1495253095552997458 -6.6584525757207861929 0.28953822842173720931 1.9301262177680222898 4.3719504325189237903 -0.4091860094097217182];

% Layer 7
b7 = [0.26678983878670708974;0.23431951857783564486];
LW7_6 = [-1.3813976953377855583 -3.0832024807522255827 -2.5828278583401513835 1.2511418262520241917 6.371443419002623898 -1.1777155889958619284 -0.826689908939810425 -6.4041245691170098908;-0.052321871877685319219 -0.49735351341919376011 0.22233536178916482595 -1.5358755453748724751 0.13304412843396692945 -2.3122035001190095471 0.88861086775122999359 -0.1786879252473373425];

% Output 1
y1_step1.ymin = -1;
y1_step1.gain = [8.03212851405623;6.68896321070234];
y1_step1.xoffset = [0.001;0.001];

% ===== SIMULATION ========

% Format Input Arguments
isCellX = iscell(X);
if ~isCellX, X = {X}; end;

% Dimensions
TS = size(X,2); % timesteps
if ~isempty(X)
  Q = size(X{1},2); % samples/series
else
  Q = 0;
end

% Allocate Outputs
Y = cell(1,TS);

% Time loop
for ts=1:TS

    % Input 1
    Xp1 = mapminmax_apply(X{1,ts},x1_step1);
    
    % Layer 1
    a1 = tansig_apply(repmat(b1,1,Q) + IW1_1*Xp1);
    
    % Layer 2
    a2 = tansig_apply(repmat(b2,1,Q) + LW2_1*a1);
    
    % Layer 3
    a3 = tansig_apply(repmat(b3,1,Q) + LW3_2*a2);
    
    % Layer 4
    a4 = tansig_apply(repmat(b4,1,Q) + LW4_3*a3);
    
    % Layer 5
    a5 = tansig_apply(repmat(b5,1,Q) + LW5_4*a4);
    
    % Layer 6
    a6 = tansig_apply(repmat(b6,1,Q) + LW6_5*a5);
    
    % Layer 7
    a7 = repmat(b7,1,Q) + LW7_6*a6;
    
    % Output 1
    Y{1,ts} = mapminmax_reverse(a7,y1_step1);
end

% Final Delay States
Xf = cell(1,0);
Af = cell(7,0);

% Format Output Arguments
if ~isCellX, Y = cell2mat(Y); end
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
  y = bsxfun(@minus,x,settings.xoffset);
  y = bsxfun(@times,y,settings.gain);
  y = bsxfun(@plus,y,settings.ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings)
  x = bsxfun(@minus,y,settings.ymin);
  x = bsxfun(@rdivide,x,settings.gain);
  x = bsxfun(@plus,x,settings.xoffset);
end
